# راهنمای رفع مشکل احراز هویت و دسترسی ادمین

## مشکل
کاربر ادمین با وجود لاگین موفق، نمی‌تواند به صفحه `/dashboard/users` دسترسی پیدا کند و به صفحه `/access-denied` ریدایرکت می‌شود.

## علت مشکل
1. توکن‌ها با نام‌های مختلف در localStorage ذخیره می‌شدند (`auth_token` vs `access_token`)
2. اطلاعات کاربر (شامل فیلد `is_admin`) به درستی از localStorage بازیابی نمی‌شد

## راه حل‌های اعمال شده

### 1. هماهنگ‌سازی نام توکن‌ها
در فایل `/app/composables/useAuth.ts`:
- توکن‌ها با هر دو نام `auth_token` و `access_token` ذخیره می‌شوند
- هنگام بازیابی، هر دو نام بررسی می‌شوند

### 2. بهبود middleware ادمین
در فایل `/app/middleware/admin.ts`:
- بررسی فیلد `is_admin` در user object
- بررسی نقش‌های `admin`, `super-admin`, `super_admin`
- انتظار برای تکمیل initialization قبل از بررسی دسترسی

### 3. صفحات کمکی برای تست

#### `/save-token` - ذخیره دستی توکن
این صفحه به شما امکان می‌دهد:
1. توکن دریافتی از API را وارد کنید
2. با کلیک روی "استفاده از اطلاعات پیش‌فرض ادمین" از توکن‌های نمونه استفاده کنید
3. اطلاعات به درستی در localStorage ذخیره می‌شود

#### `/test-auth` - بررسی وضعیت احراز هویت
نمایش:
- اطلاعات کاربر فعلی
- وضعیت ادمین بودن
- نقش‌های کاربر
- تست دسترسی‌ها

#### `/test-api` - تست مستقیم API
امکان تست:
- درخواست مستقیم با fetch
- درخواست با useApi composable
- درخواست با useAuth composable

## نحوه استفاده

### روش 1: لاگین عادی
1. به آدرس `/auth` بروید
2. شماره تلفن یا ایمیل خود را وارد کنید
3. رمز عبور یا کد OTP را وارد کنید
4. پس از لاگین موفق، به داشبورد هدایت می‌شوید

### روش 2: استفاده از توکن موجود
اگر از قبل توکن دارید (مثلا از Postman):

1. به آدرس `/save-token` بروید
2. توکن خود را در فیلد مربوطه وارد کنید
3. روی "ذخیره اطلاعات و ورود به سیستم" کلیک کنید
4. یا از دکمه "استفاده از اطلاعات پیش‌فرض ادمین" استفاده کنید

### روش 3: تست سریع با توکن نمونه
```javascript
// در Console مرورگر اجرا کنید:
localStorage.setItem('access_token', '3|aefftjK4E20n7CM14FaBP74glEAtt3mQKiaxgKek40541ef3')
localStorage.setItem('auth_token', '3|aefftjK4E20n7CM14FaBP74glEAtt3mQKiaxgKek40541ef3')
localStorage.setItem('auth_user', JSON.stringify({
  id: 1,
  name: 'مدیر سیستم',
  username: 'admin',
  email: 'admin@example.com',
  is_admin: true,
  roles: []
}))
location.reload()
```

## بررسی عملکرد صحیح

پس از لاگین یا ذخیره توکن:

1. به `/test-auth` بروید و بررسی کنید:
   - `is_admin: true` نمایش داده شود
   - اطلاعات کاربر صحیح باشد

2. به `/dashboard/users` بروید:
   - باید بدون مشکل صفحه باز شود
   - لیست کاربران نمایش داده شود

3. در صورت بروز مشکل:
   - Console مرورگر را بررسی کنید
   - از `/test-api` برای تست مستقیم API استفاده کنید

## نکات مهم

1. **توکن منقضی**: اگر توکن منقضی شده باشد، سیستم سعی می‌کند با refresh token توکن جدید دریافت کند
2. **حذف کش مرورگر**: در صورت مشکل، localStorage را پاک کنید و دوباره لاگین کنید
3. **بررسی API**: مطمئن شوید backend در `http://127.0.0.1:8000` در حال اجراست

## فایل‌های تغییر یافته

1. `/app/composables/useAuth.ts` - بهبود ذخیره و بازیابی توکن‌ها
2. `/app/middleware/admin.ts` - بهبود بررسی دسترسی ادمین
3. `/app/pages/save-token.vue` - ابزار کمکی برای ذخیره توکن
4. `/app/pages/test-auth.vue` - ابزار تست احراز هویت
5. `/app/pages/test-api.vue` - ابزار تست API

## خلاصه

مشکل اصلی در عدم هماهنگی نام‌گذاری توکن‌ها و عدم بازیابی صحیح فیلد `is_admin` از localStorage بود. با اصلاحات انجام شده، سیستم احراز هویت به درستی کار می‌کند و کاربران ادمین می‌توانند به تمام بخش‌های مورد نیاز دسترسی داشته باشند.