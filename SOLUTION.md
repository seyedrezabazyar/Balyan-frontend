# راه‌حل مشکل صفحه پروفایل

## مشکلات شناسایی شده و رفع شده:

### 1. **مشکل ارسال توکن در درخواست‌های API**
   - در فایل `app/pages/profile.vue`، متغیر `api` یک بار در ابتدای کامپوننت ایجاد می‌شد که باعث می‌شد توکن قدیمی استفاده شود
   - **راه‌حل**: در هر تابع، `api` را با توکن فعلی از `authStore` ایجاد می‌کنیم

### 2. **عدم مدیریت صحیح خطاهای احراز هویت**
   - خطای 401 (Unauthenticated) به درستی handle نمی‌شد
   - **راه‌حل**: افزودن بررسی خطای 401 و redirect به صفحه ورود

### 3. **مشکل در middleware احراز هویت**
   - عدم بررسی وجود توکن قبل از fetchUser
   - **راه‌حل**: افزودن بررسی توکن و لاگ‌های مناسب در `app/middleware/auth.ts`

### 4. **عدم ارسال همه فیلدها در آپدیت پروفایل**
   - فقط `name` و `phone` ارسال می‌شد
   - **راه‌حل**: افزودن `email` و `preferred_method` به درخواست آپدیت

## Mock API Server

چون بک‌اند Laravel در این workspace موجود نیست، یک Mock API Server ایجاد کردم:
- فایل: `server/api/auth/[...].ts`
- این سرور تمام endpoint های مورد نیاز را شبیه‌سازی می‌کند

## نحوه اجرای پروژه:

```bash
# 1. نصب وابستگی‌ها (اگر قبلاً نصب نشده)
npm install

# 2. اجرای سرور توسعه
npm run dev

# 3. باز کردن مرورگر
# http://localhost:3000
```

## تست عملکرد:

### 1. ورود به سیستم:
- به آدرس `http://localhost:3000/auth` بروید
- شماره موبایل: `09123456789`
- برای تست می‌توانید از کد OTP `123456` استفاده کنید
- یا اگر رمز عبور دارید، از رمز عبور استفاده کنید

### 2. صفحه پروفایل:
- پس از ورود، به `http://localhost:3000/profile` بروید
- اطلاعات کاربر نمایش داده می‌شود
- می‌توانید اطلاعات را ویرایش و ذخیره کنید

## تغییرات اعمال شده:

### `app/pages/profile.vue`:
1. حذف ایجاد `api` در سطح کامپوننت
2. ایجاد `api` با توکن فعلی در هر تابع
3. بهبود error handling با بررسی خطای 401
4. افزودن فیلدهای بیشتر در آپدیت پروفایل

### `app/middleware/auth.ts`:
1. افزودن بررسی وجود توکن
2. بهبود لاگ‌ها برای debugging
3. بررسی دقیق‌تر وضعیت احراز هویت

### `nuxt.config.ts`:
1. تغییر `apiBase` برای استفاده از Mock API در صورت عدم وجود بک‌اند

## نکات مهم برای اتصال به بک‌اند واقعی:

اگر می‌خواهید به بک‌اند Laravel واقعی متصل شوید:

1. **اجرای بک‌اند Laravel**:
   ```bash
   cd [مسیر پروژه Laravel]
   php artisan serve --port=8000
   ```

2. **تنظیم متغیر محیطی**:
   ```bash
   # ایجاد فایل .env
   echo "NUXT_PUBLIC_API_BASE=http://localhost:8000/api" > .env
   ```

3. **بررسی CORS در Laravel**:
   مطمئن شوید که CORS در Laravel به درستی تنظیم شده است

## مشکلات احتمالی بک‌اند Laravel:

خطای 500 در بک‌اند ممکن است به دلایل زیر باشد:

1. **عدم اتصال به دیتابیس**
2. **عدم وجود جداول** (نیاز به اجرای migrations)
3. **مشکل در تنظیمات .env Laravel**
4. **خطا در کد AuthController.php**

برای رفع این مشکلات در Laravel:
```bash
# بررسی اتصال دیتابیس
php artisan db:show

# اجرای migrations
php artisan migrate

# پاک کردن cache
php artisan cache:clear
php artisan config:clear
```